@using System.IO;
@using System.IO.Compression;
@using Ionic.Zip;

@{
    string path = "";
    var id = "";
    List<int> selectedId = Session["selectListId"] as List<int>;
    var db = Database.Open("StarterSite");
    var username = WebSecurity.CurrentUserName;
    int length = selectedId.Count;
    string[] download = new string[length];

    length = 0;

    for (int i = 0; i < selectedId.Count; i++)
    {
        if (selectedId[i] != 0)
        {
            length += 1;
        }
    }

    string[] goed = new string[length];

    if (WebSecurity.IsAuthenticated)
    {
        foreach (int i in selectedId)
        { if (selectedId[i] != 0)
            {
                id = Convert.ToString(selectedId[i]);
                var command = "SELECT Books.Path, Books.Id, Books.Gebruiker, UserProfile.UserId, UserProfile.Email FROM Books, UserProfile WHERE Books.Gebruiker = UserProfile.UserId AND Books.Id = @0 AND UserProfile.Email = @1";
                var row = db.QuerySingle(command, id, username);
                if (row != null)
                {
                    path = row.Path;
                }
                else
                {
                    Validation.AddFormError("Er gaat iets fout.");
                }

                string filename = path.Substring(14);
                string file = path.Substring(6);
                string filepath = Server.MapPath(file);

                download[i] = filepath;
            }
        }

        for (int i = 0; i < length; i ++)
        {
            goed[i] = download[i];
        }

        using (ZipFile Zip = new ZipFile())
        {
            Zip.AddFiles(goed, "Boeken");

            string zipName = String.Format("Boeken_{0}.zip", DateTime.Now.ToString("yyyy-MMM-dd-HHmmss"));
            Response.ContentType = "application/zip";
            Response.AddHeader("content-disposition", "attachment; filename=" + zipName);
            Zip.Save(Response.OutputStream);
            Response.End();
            Response.Redirect("~/List.cshtml");
        }

    }
    else
    {
        Response.Redirect("~/Default.cshtml");
    }
}