@{
    // Title and layout.
    Page.Title = "Mijn Boeken";
    Layout = "~/_BookListLayout.cshtml";

    // Check Login.
    if (!WebSecurity.IsAuthenticated)
    {
        Response.Redirect("~/Default.cshtml");
    }

    // Open database
    var userId = WebSecurity.CurrentUserId;

    var db = Database.Open("StarterSite");
    var selectQueryString = "SELECT * FROM Books WHERE Gebruiker = " + userId + " ORDER BY Titel";
    string sortBy = "";
    string sortOrder = Request.QueryString["sortOrder"];
    string srQuery = Request.QueryString["sr"];
    string searchTermQuery = Request.QueryString["searchbar"];

    if (!IsPost)
    {
        // Sorting books.
        if (!srQuery.IsEmpty() && srQuery.Length < 12 && srQuery.Any(c => char.IsLetterOrDigit(c)))
        {
            sortBy = " ORDER BY " + Request.QueryString["sr"];
            if (sortOrder != "ASC" && sortOrder != "DESC")
            {
                sortOrder = "ASC";
            }
            selectQueryString = "SELECT * FROM Books WHERE Gebruiker = " + userId + sortBy + " " + sortOrder;

        }

        // Geef sterren aanboek.
        if (!Request.QueryString["st"].IsEmpty() && Request.QueryString["st"].AsInt() >= 0)
        {
            var clickedStar = Request.QueryString["st"].AsInt() + 1;
            var bookId = Request.QueryString["id"].AsInt();

            var statement = "UPDATE Books SET Beoordeling = @0 WHERE Id = @1";
            db.Execute(statement, clickedStar, bookId);
        }


        // Searchbar
        if (!Request.QueryString["searchbar"].IsEmpty())
        {
            var searchCommand = "SELECT * FROM Movies WHERE Title LIKE @0";
            var searchTerm = "%" + Request["searchbar"] + "%";
        }
    }

    // List met geselecteerd uit lijst

    List<bool> selectList = new List<bool>();
    List<int> selectListId = new List<int>();

    foreach (var row in db.Query(selectQueryString))
    {
        selectList.Add(false);
        selectListId.Add(0);
    }

    if (Session["selectList"] == null)
    {
        Session["selectList"] = selectList;
        Session["selectListId"] = selectListId;
    }

}

<div class="container-fluid">
    <div class="row">
        <div class="col-sm-2">
            <form method="get">
                @Html.ValidationSummary()
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Search for..." name="searchbar" value="@Request["searchbar"]" />
                    <input type="submit" class="btn btn-default" value="search"/>
                </div><!-- /input-group -->
            </form>
            <hr />
            <ul class="list-group">
                @{
                    string[] columnNames = new string[] { "Titel", "Auteur", "UploadDatum", "Grootte", "Beoordeling", "Serie", "Uitgever", "UitgaveDatum", "Taal" };
                    var amountStatement = "SELECT COUNT(Gebruiker) FROM Books WHERE Gebruiker = " + userId;
                    var totalAmount = db.QueryValue(amountStatement);
                    string newSort = Request.QueryString["newSort"];

                    for (int i = 0; i < columnNames.Length; i++)
                    {
                        string currCol = columnNames[i];
                        var countStatement = "SELECT COUNT(" + currCol + ") FROM Books WHERE Gebruiker = " + userId + " GROUP BY " + currCol;
                        var amount = totalAmount - db.QueryValue(countStatement) + 1;

                        string newSortOrder = "ASC";
                        string newSortOrderIcon = "32";
                        if (newSort == "1" && srQuery == columnNames[i])
                        {
                            if (sortOrder == "ASC")
                            {
                                newSortOrder = "DESC";
                                newSortOrderIcon = "9660";
                            }
                            else
                            {
                                newSortOrder = "ASC";
                                newSortOrderIcon = "9650";
                            }
                        }
                        if (srQuery != "Beoordeling" && columnNames[i] == "Beoordeling")
                        {
                            newSortOrder = "DESC";
                        }
                        <li class="list-group-item"><a href="~/List.cshtml?sr=@columnNames[i]&newSort=1&sortOrder=@newSortOrder&searchbar=@searchTermQuery">&#@newSortOrderIcon; @columnNames[i]</a> <span class="badge">@amount</span></li>
                    }
                }
            </ul>
        </div>
        <div class="col-sm-7">
            <div class="listcard">
                <form method="post">
                    <table class="table table-responsive">
                        <thead>
                            <tr>
                                <th>Titel</th>
                                <th>Auteur</th>
                                <th>Datum</th>
                                <th>Grootte (mb)</th>
                                <th>Beoordeling</th>
                                <th>Tags</th>
                                <th>Serie</th>
                                <th>Uitgever</th>
                                <th>Uitgave-datum</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                selectList = (List<bool>)Session["selectList"];
                                selectListId = (List<int>)Session["selectListId"];

                                foreach (var row in db.Query(selectQueryString))
                                {
                                    if (!IsPost)
                                    {

                                        if (!Request.QueryString["id"].IsEmpty() && Request.QueryString["id"].AsInt() > 0)
                                        {
                                            var bookId = Request.QueryString["id"];

                                            if (row.ID == bookId.AsInt())
                                            {
<<<<<<< HEAD
                                                int emptyIndex = selectListId.IndexOf(0);
                                                selectList[emptyIndex] = true;
                                                selectListId[emptyIndex] = bookId.AsInt();
                                            }
                                            else
                                            {

                                                selectList[index] = false;
                                                selectListId[index] = 0;

=======

                                                int index = selectListId.IndexOf(row.ID);
                                                if (index == -1)
                                                {
                                                    int emptyIndex = selectListId.IndexOf(0);
                                                    selectList[emptyIndex] = true;
                                                    selectListId[emptyIndex] = bookId.AsInt();
                                                }
                                                else
                                                {

                                                    selectList[index] = false;
                                                    selectListId[index] = 0;

                                                }
>>>>>>> origin/master
                                            }

                                        }
                                    }


<<<<<<< HEAD
                                if (selectListId.IndexOf(Convert.ToInt32(row.ID)) != -1)
                                {
                                    <tr class="selectedTable">
                                        <td><a href="~/List.cshtml?sr=@srQuery&newSort=0&sortOrder=@sortOrder&searchbar=@searchTermQuery&id=@row.ID">@row.Titel</a></td>
                                        <td><a href="~/List.cshtml?sr=@srQuery&newSort=0&sortOrder=@sortOrder&searchbar=@searchTermQuery&id=@row.ID">@row.Auteur</a></td>
                                        <td><a href="~/List.cshtml?sr=@srQuery&newSort=0&sortOrder=@sortOrder&searchbar=@searchTermQuery&id=@row.ID">@row.UploadDatum.ToString("dd-MMM-yy")</a></td>
                                        <td><a href="~/List.cshtml?sr=@srQuery&newSort=0&sortOrder=@sortOrder&searchbar=@searchTermQuery&id=@row.ID">@row.Grootte</a></td>
                                        <td>
                                            @{
                                                for (int i = 0; i < 5; i++)
                                                {
                                                    if (i < row.Beoordeling)
=======
                                    if (selectListId.IndexOf(Convert.ToInt32(row.ID)) != -1)
                                    {
                                        <tr class="selectedTable">
                                            <td><a href="~/List.cshtml?sr=@sortBy&id=@row.ID">@row.Titel</a></td>
                                            <td><a href="~/List.cshtml?sr=@sortBy&id=@row.ID">@row.Auteur</a></td>
                                            <td><a href="~/List.cshtml?sr=@sortBy&id=@row.ID">@row.UploadDatum.ToString("dd-MMM-yy")</a></td>
                                            <td><a href="~/List.cshtml?sr=@sortBy&id=@row.ID">10mb</a></td>
                                            <td>
                                                @{
                                                    for (int i = 0; i < 5; i++)
>>>>>>> origin/master
                                                    {
                                                        if (i < row.Beoordeling)
                                                        {
                                                            <a href="~/List.cshtml?sr=@sortBy&id=@row.ID&st=@i"><img src='~/Books/Coverart/star.png' width="12" alt='*' /></a>
                                                        }
                                                        else
                                                        {
                                                            <a href="~/List.cshtml?sr=@sortBy&id=@row.ID&st=@i"><img src='~/Books/Coverart/starempty.png' width="12" alt='' /></a>
                                                        }
                                                    }
                                                }
                                                    </td>
                                                        <td><a href="~/List.cshtml?sr=@sortBy&id=@row.ID">@row.Tags</a></td>
                                                        <td><a href="~/List.cshtml?sr=@sortBy&id=@row.ID">@row.Serie</a></td>
                                                        <td><a href="~/List.cshtml?sr=@sortBy&id=@row.ID">@row.Uitgever</a></td>
                                                        <td><a href="~/List.cshtml?sr=@sortBy&id=@row.ID">@row.UitgaveDatum</a></td>
                                                    </tr>

                                                    }
                                                    else
                                                    {
<<<<<<< HEAD
                                                        <a href="~/List.cshtml?sr=@sortBy&id=@row.ID&st=@i"><img src='~/Books/Coverart/starempty.png' width="12" alt='' /></a>
                                                    }
                                                }
                                            }
                                        </td>
                                        <td><a href="~/List.cshtml?sr=@srQuery&newSort=0&sortOrder=@sortOrder&searchbar=@searchTermQuery&id=@row.ID">@row.Tags</a></td>
                                        <td><a href="~/List.cshtml?sr=@srQuery&newSort=0&sortOrder=@sortOrder&searchbar=@searchTermQuery&id=@row.ID">@row.Serie</a></td>
                                        <td><a href="~/List.cshtml?sr=@srQuery&newSort=0&sortOrder=@sortOrder&searchbar=@searchTermQuery&id=@row.ID">@row.Uitgever</a></td>
                                        <td><a href="~/List.cshtml?sr=@srQuery&newSort=0&sortOrder=@sortOrder&searchbar=@searchTermQuery&id=@row.ID">@row.UitgaveDatum</a></td>
                                    </tr>

                                                }
                                                else
                                                {
                                              
                                                    <tr>
                                                        <td><a href="~/List.cshtml?sr=@srQuery&newSort=0&sortOrder=@sortOrder&searchbar=@searchTermQuery&id=@row.ID">@row.Titel</a></td>
                                                        <td><a href="~/List.cshtml?sr=@srQuery&newSort=0&sortOrder=@sortOrder&searchbar=@searchTermQuery&id=@row.ID">@row.Auteur</a></td>
                                                        <td><a href="~/List.cshtml?sr=@srQuery&newSort=0&sortOrder=@sortOrder&searchbar=@searchTermQuery&id=@row.ID">@row.UploadDatum.ToString("dd-MMM-yy")</a></td>
                                                        <td><a href="~/List.cshtml?sr=@srQuery&newSort=0&sortOrder=@sortOrder&searchbar=@searchTermQuery&id=@row.ID">@row.Grootte</a></td>
                                                        <td>
                                                            @{
                                                                for (int i = 0; i < 5; i++)
                                                                {
                                                                    if (i < row.Beoordeling)
                                                                    {
                                                                        <a href="~/List.cshtml?sr=@srQuery&newSort=0&sortOrder=@sortOrder&searchbar=@searchTermQuery&id=@row.ID&st=@i"><img src='~/Books/Coverart/star.png' width="12" alt='*' /></a>
                                                                    }
                                                                    else
                                                                    {
                                                                        <a href="~/List.cshtml?sr=@srQuery&newSort=0&sortOrder=@sortOrder&searchbar=@searchTermQuery&id=@row.ID&st=@i"><img src='~/Books/Coverart/starempty.png' width="12" alt='' /></a>
                                                                    }
                                                                }
                                                            }
                                                        </td>
                                                        <td><a href="~/List.cshtml?sr=@srQuery&newSort=0&sortOrder=@sortOrder&searchbar=@searchTermQuery&id=@row.ID">@row.Tags</a></td>
                                                        <td><a href="~/List.cshtml?sr=@srQuery&newSort=0&sortOrder=@sortOrder&searchbar=@searchTermQuery&id=@row.ID">@row.Serie</a></td>
                                                        <td><a href="~/List.cshtml?sr=@srQuery&newSort=0&sortOrder=@sortOrder&searchbar=@searchTermQuery&id=@row.ID">@row.Uitgever</a></td>
                                                        <td><a href="~/List.cshtml?sr=@srQuery&newSort=0&sortOrder=@sortOrder&searchbar=@searchTermQuery&id=@row.ID">@row.UitgaveDatum</a></td>
                                                    </tr>
=======

                                                        <tr>
                                                            <td><a href="~/List.cshtml?sr=@sortBy&id=@row.ID">@row.Titel</a></td>
                                                            <td><a href="~/List.cshtml?sr=@sortBy&id=@row.ID">@row.Auteur</a></td>
                                                            <td><a href="~/List.cshtml?sr=@sortBy&id=@row.ID">@row.UploadDatum.ToString("dd-MMM-yy")</a></td>
                                                            <td><a href="~/List.cshtml?sr=@sortBy&id=@row.ID">10mb</a></td>
                                                            <td>
                                                                @{
                                                                    for (int i = 0; i < 5; i++)
                                                                    {
                                                                        if (i < row.Beoordeling)
                                                                        {
                                                                            <a href="~/List.cshtml?sr=@sortBy&id=@row.ID&st=@i"><img src='~/Books/Coverart/star.png' width="12" alt='*' /></a>
                                                                        }
                                                                        else
                                                                        {
                                                                            <a href="~/List.cshtml?sr=@sortBy&id=@row.ID&st=@i"><img src='~/Books/Coverart/starempty.png' width="12" alt='' /></a>
                                                                        }
                                                                    }
                                                                }
                                                            </td>
                                                            <td><a href="~/List.cshtml?sr=@sortBy&id=@row.ID">@row.Tags</a></td>
                                                            <td><a href="~/List.cshtml?sr=@sortBy&id=@row.ID">@row.Serie</a></td>
                                                            <td><a href="~/List.cshtml?sr=@sortBy&id=@row.ID">@row.Uitgever</a></td>
                                                            <td><a href="~/List.cshtml?sr=@sortBy&id=@row.ID">@row.UitgaveDatum</a></td>
                                                        </tr>
                                    }
>>>>>>> origin/master
                                }
                            }
                        </tbody>
                    </table>
                </form>
            </div>
        </div>
        <div class="col-sm-3">
            @{
                int selectedbooks = 0;
                foreach (int i in selectListId)
                {
                    if (i != 0)
                    {
                        selectedbooks++;
                    }
                }

                if (selectedbooks > 0)
                {
                    <h4 id="selectedbooks">Aantal boeken geselecteerd: @selectedbooks</h4>           
                    <h6>
                        <a class="btn btn-default btn-sm" href="~/Books/BooksDownload.cshtml">Download</a>
                        <a class="btn btn-default btn-sm" href="~/Books/BooksEmail.cshtml">E-mail</a>
                        <a class="btn btn-danger accent-color btn-sm" href="~/Books/BooksDelete.cshtml">Verwijderen</a>
                    </h6>
                    <hr />
                }
                else
                {
                    <h4 id="selectedbooks">Welkom op terug op E-Book Online!</h4>
                    <p><b>Tip:</b> Selecteer één of meerdere boeken uit uw bibliotheek voor meer Info.</p>
                }
            }
                        
            @if (!IsPost)
            {
                // Create a list from selected books.
                for (int i = 0; i < selectListId.Count; i++)
                {
                    // If ListId = 0: There is no selected book.
                    if (selectListId[i] != 0)
                    {
                        // Count the amount off !selected books. 
                        int countEmpty = 0;
                        foreach (int ii in selectListId)
                        {
                            if (ii == 0)
                            {
                                countEmpty++;
                            }
                        }

                        // If there is only 1 books selected. Show big "preview"
                        if (countEmpty  > selectListId.Count-2)
                        {
                            // Select book Info
                            var statement = "SELECT * FROM Books WHERE Id = @0";
                            var bookInfo = db.QuerySingle(statement, selectListId[i]);

                            <div class="bookinfocard">
                                <a href="~/Books/BooksView.cshtml?id=@bookInfo.Id"><span></span></a>
                                <div class="bookinfoheading">
                                    <h3 class="panel-title text-center">@bookInfo.Titel - <a style="font-size: 14px" href="~/Books/BooksView.cshtml?id=@bookInfo.Id">View Book</a></h3>
                                </div>
                                
                                <div class="bookinfobody">
                                    <img src="~/img/Enchantment-Book-Cover-Best-Seller1.jpg" alt="bookcover" width="100" text-align="center" />
                                    <h5>Auteur:</h5>
                                    <p>@bookInfo.Titel</p>
                                    <h5>Taal</h5>
                                    <p>@bookInfo.Taal</p>
                                    <h5>Beschrijving</h5>
                                    <p>@bookInfo.Beschrijving</p>
                                </div>
                                
                            </div>
                        }
                        else
                        {
                            // Select book Info
                            var statement = "SELECT * FROM Books WHERE Id = @0";
                            var bookInfo = db.QuerySingle(statement, selectListId[i]);

                            <div class="bookinfocard">
                                <a href="~/Books/BooksView.cshtml?id=@bookInfo.Id"><span></span></a>
                                <div class="bookinfoheading">
                                    <h3 class="panel-title text-center">@bookInfo.Titel - <a style="font-size: 14px" href="~/Books/BooksView.cshtml?id=@bookInfo.Id">View Book</a></h3> 
                                </div>
                                <div class="bookinfobody">                                 
                                    <h5>Auteur: @bookInfo.Auteur</h5>                
                                    <h5>Taal: @bookInfo.Taal</h5>
                                </div>
                            </div>
                            <br />
                        }                      
                    }
                }
            }
        </div>
    </div>
</div>
