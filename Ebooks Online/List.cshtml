@{
    // Title and layout.
    Page.Title = "Mijn Boeken";
    Layout = "~/_BookListLayout.cshtml";


    // Check Login.
    if (!WebSecurity.IsAuthenticated)
    {
        Response.Redirect("~/Default.cshtml");
    }

    // Open database
    var userId = WebSecurity.CurrentUserId;

    var db = Database.Open("StarterSite");
    var selectQueryString = "SELECT * FROM Books WHERE Gebruiker = " + userId + " ORDER BY Titel";


    // List met geselecteerd uit lijst

    List<bool> selectList = new List<bool>();
    List<int> selectListId = new List<int>();

    foreach (var row in db.Query(selectQueryString))
    {
        selectList.Add(false);
        selectListId.Add(0);
    }

    if (Session["selectList"] == null)
    {
        Session["selectList"] = selectList;
        Session["selectListId"] = selectListId;
    }

    // Sorting the book list. 
    string sortOrder = "a";
    string sortBy = Request.QueryString["sr"];
    string searchTermQuery = Request.QueryString["searchbar"];

    string[] columnNames = new string[] { "Titel", "Auteur", "UploadDatum", "Grootte", "Beoordeling", "Serie", "Uitgever", "UitgaveDatum", "Taal" };

    if (!IsPost)
    {

        // Sorting books.
        if (!Request.QueryString["sr"].IsEmpty())
        {
            if (sortBy[1].ToString() == "a")
            {
                sortOrder = "b";
            }
            else
            {
                sortOrder = "a";
            }

            int sortCount = (int)char.GetNumericValue(sortBy[0]);
            char sortDescAsc = sortBy[1];
            if (sortDescAsc == 'a')
            {
                selectQueryString = "SELECT * FROM Books WHERE Gebruiker = " + userId + " ORDER BY " + columnNames[sortCount] + " DESC";
            }
            else
            {
                selectQueryString = "SELECT * FROM Books WHERE Gebruiker = " + userId + " ORDER BY " + columnNames[sortCount] + " ASC";
            }
        }
        else
        {
            sortBy = "0b";
        }

        // Give Books a star rating. Max 5/5.
        if (!Request.QueryString["st"].IsEmpty() && Request.QueryString["st"].AsInt() >= 0)
        {

            var rating = Request.QueryString["st"]; // Contains the rating and which book got rated
            var stars = rating[rating.Length - 1]; // Number off Stars
            var rated = ""; // Which book got rated

            for(int i = 0; i < rating.Length - 1; i++)
            {
                rated += rating[i];
            }

            var statement = "UPDATE Books SET Beoordeling = @0 WHERE Id = @1";
            db.Execute(statement, (int)char.GetNumericValue(stars) + 1, rated);
        }


        // Searchbar
        if (!Request.QueryString["searchbar"].IsEmpty())
        {
            var searchCommand = "SELECT * FROM Movies WHERE Title LIKE @0";
            var searchTerm = "%" + Request["searchbar"] + "%";
        }
    }
}

<div class="container-fluid">
    <div class="row">
        <div class="col-sm-2">
            <ul class="sortcard list-unstyled">
                @{        
                    for (int i = 0; i < columnNames.Length; i++)
                    {
                        string currCol = columnNames[i];
                        var countStatement = "SELECT " + currCol + " FROM Books WHERE Gebruiker = " + userId + " GROUP BY " + currCol;
                        var countQueryVal = db.Query(countStatement);
                        var amount = countQueryVal.Count();


                        if (sortBy.Length > 2)
                        {
                            if (sortBy[1] == 'a')
                            {
                                sortOrder = "b";
                            }
                            else
                            {
                                sortOrder = "a";
                            }

                        }

                        string sortBySwitch = i + sortOrder + 1;

                        // Set the indicator when selected. 
                        string indicator = "32";
                        int sortCount = (int)char.GetNumericValue(sortBy[0]);
                        if (sortCount == i)
                        {
                            if (sortBy[1] == 'a')
                            {
                                indicator = "9660";
                            }
                            else
                            {
                                indicator = "9650";
                            }
                        }

                        <li>
                            <a href="~/List.cshtml?sr=@sortBySwitch">&#@indicator; @columnNames[i]</a> <span class="badge" style="float: right;">@amount</span>
                            @{ 
                                if (sortCount == i)
                                {
                                    // Make a list from all unique columnNames[i]. Example all inique authors are listed.
                                    var sortQuery = "SELECT " + columnNames[i] + " FROM Books WHERE Gebruiker = " + userId + " GROUP BY " + columnNames[i];
                                    <ul class="sortList">   
                                        
                                        @foreach (var row in db.Query(sortQuery))
                                        { 
                                            // Select all ID's from the books with the (for example) author names.
                                            var sortFindQuery = "SELECT Id FROM Books WHERE " + columnNames[i] + " = @0";
                                            string selectBooks = "";

                                            // Make a string for passing the selected books.
                                            foreach (var id in db.Query(sortFindQuery, row[0]))
                                            {
                                                selectBooks += id[0];
                                                selectBooks += "+";
                                            }
                                            
                                            // Remove the "+" at the end of the string.
                                            string selectedBooks = "";
                                            if (selectBooks[selectBooks.Length-1]== '+')
                                            {
                                                for (int ii = 0; ii < selectBooks.Length - 1; ii++)
                                                {
                                                    selectedBooks += selectBooks[ii];
                                                }
                                            }
                                            else
                                            {
                                                // Only 1 book is selected.
                                                selectedBooks = selectBooks; 
                                            }

                                            <li><a href="~/List.cshtml?sr=@sortBy&at=@selectedBooks">@row[0]</a></li>
                                        }
                                    </ul>
                                }

                            }
                            @if (currCol != "Taal")
                            {
                                <hr class="sortdivider" />
                            }      
                        </li>
                    }
                }
            </ul>
        </div>

        
        <div class="col-sm-7">
            <form class="searchform" method="get">
                @Html.ValidationSummary()
                <div class="group">
                    <input class="inputmaterial" type="search" placeholder="Druk op enter om te zoeken..." name="sb" value="@Request["sb"]" />
                    <span class="bar"></span>
                </div>
            </form>

            <hr style="margin-top: 10px; margin-bottom: 10px;"/>
            
            <!-- Creating the booklist -->
            @Helpers.createBookList(selectListId, db, selectQueryString, sortBy); 
        </div>
        <div class="col-sm-3">
            @{
                int selectedbooks = 0;
                foreach (int i in selectListId)
                {
                    if (i != 0)
                    {
                        selectedbooks++;
                    }
                }

                if (selectedbooks > 0)
                {
                    <h4 id="selectedbooks">Aantal boeken geselecteerd: @selectedbooks</h4>
                    <h6>
                        <a class="btn btn-default btn-sm" href="~/Books/BooksDownload.cshtml">Download</a>
                        <a class="btn btn-default btn-sm" href="~/Books/BooksEmail.cshtml">E-mail</a>
                        <a class="btn btn-danger accent-color btn-sm" href="~/Books/BooksDelete.cshtml">Verwijderen</a>
                    </h6>
                    <hr />
                }
                else
                {
                    <h4 id="selectedbooks">Welkom terug op E-Book Online!</h4>
                    <p><b>Tip:</b> Selecteer één of meerdere boeken uit uw bibliotheek voor meer Info.</p>
                }
            }

            @if (!IsPost)
            {
                // Create a list from selected books.
                for (int i = 0; i < selectListId.Count; i++)
                {
                    // If ListId = 0: There is no selected book.
                    if (selectListId[i] != 0)
                    {
                        // Count the amount off !selected books.
                        int countEmpty = 0;
                        foreach (int ii in selectListId)
                        {
                            if (ii == 0)
                            {
                                countEmpty++;
                            }
                        }

                        // If there is only 1 books selected. Show big "preview"
                        if (countEmpty > selectListId.Count - 2)
                        {
                            // Select book Info
                            var statement = "SELECT * FROM Books WHERE Id = @0";
                            var bookInfo = db.QuerySingle(statement, selectListId[i]);

                            <div class="bookinfocard">
                                <a href="~/Books/BooksView.cshtml?id=@bookInfo.Id"><span></span></a>
                                <div class="bookinfoheading">
                                    <h3 class="panel-title text-center">@bookInfo.Titel</h3>
                                </div>

                                <div class="bookinfobody">
                                    <img src="~/img/Enchantment-Book-Cover-Best-Seller1.jpg" alt="bookcover" width="100" text-align="center" />
                                    <h5>Auteur:</h5>
                                    <p>@bookInfo.Titel</p>
                                    <h5>Taal</h5>
                                    <p>@bookInfo.Taal</p>
                                    <h5>Beschrijving</h5>
                                    <p>@bookInfo.Beschrijving</p>
                                </div>

                            </div>
                        }
                        else
                        {
                            // Select book Info
                            var statement = "SELECT * FROM Books WHERE Id = @0";
                            var bookInfo = db.QuerySingle(statement, selectListId[i]);

                            <div class="bookinfocard">
                                <a href="~/Books/BooksView.cshtml?id=@bookInfo.Id"><span></span></a>
                                <div class="bookinfoheading">
                                    <h3 class="panel-title text-center">@bookInfo.Titel</h3>
                                </div>
                                <div class="bookinfobody">
                                    <h5>Auteur: @bookInfo.Auteur</h5>
                                    <h5>Taal: @bookInfo.Taal</h5>
                                </div>
                            </div>
                            <br />
                        }
                    }
                }
            }
        </div>
    </div>
</div>
